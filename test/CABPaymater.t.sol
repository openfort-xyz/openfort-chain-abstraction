// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import {Test, console} from "forge-std/Test.sol";
import {EntryPoint} from "account-abstraction/core/EntryPoint.sol";
import {PackedUserOperation} from "account-abstraction/core/UserOperationLib.sol";
import {MessageHashUtils} from "@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol";
import {CABPaymaster} from "../src/paymasters/CABPaymaster.sol";
import {ECDSA} from "@openzeppelin/contracts/utils/cryptography/ECDSA.sol";
import {InvoiceManager} from "../src/core/InvoiceManager.sol";
import {VaultManager} from "../src/vaults/VaultManager.sol";
import {IVault} from "../src/interfaces/IVault.sol";
import {IVaultManager} from "../src/interfaces/IVaultManager.sol";
import {BaseVault} from "../src/vaults/BaseVault.sol";
import {IInvoiceManager} from "../src/interfaces/IInvoiceManager.sol";
import {UpgradeableOpenfortProxy} from "../src/proxy/UpgradeableOpenfortProxy.sol";
import {MockERC20} from "../src/mocks/MockERC20.sol";
import {MessageHashUtils} from "@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol";
import {IPaymasterVerifier} from "../src/interfaces/IPaymasterVerifier.sol";
import {UserOpSettlement} from "../src/settlement/UserOpSettlement.sol";
import {IPaymaster} from "account-abstraction/interfaces/IPaymaster.sol";
import {ICrossL2Prover} from "@vibc-core-smart-contracts/contracts/interfaces/ICrossL2Prover.sol";
import {MockCrossL2Prover} from "../src/mocks/MockCrossL2Prover.sol";

contract CABPaymasterTest is Test {
    uint256 immutable BASE_SEPOLIA_CHAIN_ID = 84532;
    uint256 immutable OPTIMISM_CHAIN_ID = 11155420;
    uint256 immutable PAYMSTER_BASE_MOCK_ERC20_BALANCE = 100000;

    CABPaymaster public paymaster;
    InvoiceManager public invoiceManager;
    VaultManager public vaultManager;
    ICrossL2Prover public crossL2Prover;
    BaseVault public openfortVault;
    MockERC20 public mockERC20;

    EntryPoint public entryPoint;

    UserOpSettlement public settlement;

    address public verifyingSignerAddress;
    uint256 public verifyingSignerPrivateKey;
    address public owner;
    address public rekt;

    function setUp() public {
        entryPoint = new EntryPoint();
        owner = address(1);

        rekt = address(0x9590Ed0C18190a310f4e93CAccc4CC17270bED40);
        crossL2Prover = ICrossL2Prover(address(new MockCrossL2Prover()));

        verifyingSignerPrivateKey = uint256(keccak256(abi.encodePacked("VERIFIYING_SIGNER")));
        verifyingSignerAddress = vm.addr(verifyingSignerPrivateKey);
        vm.label(verifyingSignerAddress, "VERIFIYING_SIGNER");

        invoiceManager = InvoiceManager(payable(new UpgradeableOpenfortProxy(address(new InvoiceManager()), "")));
        vaultManager = VaultManager(
            payable(
                new UpgradeableOpenfortProxy(
                    address(new VaultManager()),
                    abi.encodeWithSelector(
                        VaultManager.initialize.selector, owner, IInvoiceManager(address(invoiceManager)), 42
                    )
                )
            )
        );
        mockERC20 = new MockERC20();
        console.log("mockERC20", address(mockERC20));
        openfortVault = BaseVault(
            payable(
                new UpgradeableOpenfortProxy(
                    address(new BaseVault()),
                    abi.encodeWithSelector(
                        BaseVault.initialize.selector, IVaultManager(address(vaultManager)), mockERC20
                    )
                )
            )
        );
        invoiceManager.initialize(owner, IVaultManager(address(vaultManager)));
        settlement = UserOpSettlement(payable(new UpgradeableOpenfortProxy(address(new UserOpSettlement()), "")));
        paymaster = new CABPaymaster(entryPoint, invoiceManager, crossL2Prover, verifyingSignerAddress, owner);
        settlement.initialize(owner, address(paymaster));

        mockERC20.mint(address(paymaster), PAYMSTER_BASE_MOCK_ERC20_BALANCE);

        assertEq(address(invoiceManager.vaultManager()), address(vaultManager));
        assertEq(address(vaultManager.invoiceManager()), address(invoiceManager));

        vm.startPrank(rekt);
        invoiceManager.registerPaymaster(
            address(paymaster), IPaymasterVerifier(address(paymaster)), block.timestamp + 100000
        );
    }

    function getEncodedSponsorTokens(uint8 len) internal returns (bytes memory encodedSponsorToken) {
        IPaymasterVerifier.SponsorToken[] memory sponsorTokens = new IPaymasterVerifier.SponsorToken[](len);
        for (uint8 i = 0; i < len; i++) {
            sponsorTokens[i] = IPaymasterVerifier.SponsorToken({token: address(mockERC20), spender: rekt, amount: 500});
            encodedSponsorToken = bytes.concat(
                encodedSponsorToken,
                bytes20(sponsorTokens[i].token),
                bytes20(sponsorTokens[i].spender),
                bytes32(sponsorTokens[i].amount)
            );
        }
        return abi.encodePacked(uint8(len), encodedSponsorToken);
    }

    function encodeRepayToken(IInvoiceManager.RepayTokenInfo[] memory repayTokens)
        internal
        pure
        returns (bytes memory encodedRepayToken)
    {
        for (uint8 i = 0; i < repayTokens.length; i++) {
            encodedRepayToken = bytes.concat(
                encodedRepayToken,
                bytes20(address(repayTokens[i].vault)),
                bytes32(repayTokens[i].amount),
                bytes32(repayTokens[i].chainId)
            );
        }
        return abi.encodePacked(uint8(repayTokens.length), encodedRepayToken);
    }

    function getEncodedRepayTokens(uint8 len) internal returns (bytes memory encodedRepayToken) {
        IInvoiceManager.RepayTokenInfo[] memory repayTokens = new IInvoiceManager.RepayTokenInfo[](len);
        for (uint8 i = 0; i < len; i++) {
            repayTokens[i] =
                IInvoiceManager.RepayTokenInfo({vault: openfortVault, amount: 500, chainId: OPTIMISM_CHAIN_ID});
            encodedRepayToken = bytes.concat(
                encodedRepayToken,
                bytes20(address(repayTokens[i].vault)),
                bytes32(repayTokens[i].amount),
                bytes32(repayTokens[i].chainId)
            );
        }
        return abi.encodePacked(uint8(len), encodedRepayToken);
    }

    function testEncodeRepayToken() public {
        IInvoiceManager.RepayTokenInfo[] memory repayTokens = new IInvoiceManager.RepayTokenInfo[](1);
        repayTokens[0] = IInvoiceManager.RepayTokenInfo({
            vault: IVault(address(0x8e2048c85Eae2a4443408C284221B33e61906463)),
            amount: 500,
            chainId: OPTIMISM_CHAIN_ID
        });
        bytes memory encodedRepayToken = encodeRepayToken(repayTokens);
        assertEq(
            encodedRepayToken,
            hex"018e2048c85Eae2a4443408C284221B33e6190646300000000000000000000000000000000000000000000000000000000000001f40000000000000000000000000000000000000000000000000000000000aa37dc"
        );
    }

    function testValidateUserOp() public {
        vm.chainId(BASE_SEPOLIA_CHAIN_ID);
        bytes memory sponsorTokensBytes = getEncodedSponsorTokens(1);
        bytes memory repayTokensBytes = getEncodedRepayTokens(1);

        uint48 validUntil = 1732810044 + 1000;
        uint48 validAfter = 1732810044;
        uint128 preVerificationGas = 1e5;
        uint128 postVerificationGas = 1e5;

        bytes memory paymasterAndData = bytes.concat(
            bytes20(address(paymaster)),
            bytes16(preVerificationGas),
            bytes16(postVerificationGas),
            bytes6(validUntil),
            bytes6(validAfter),
            repayTokensBytes,
            sponsorTokensBytes
        );

        PackedUserOperation memory userOp = PackedUserOperation({
            sender: rekt,
            nonce: 31994562304018791559173496635392,
            initCode: "",
            callData: "",
            accountGasLimits: bytes32(uint256(1e18)),
            preVerificationGas: preVerificationGas,
            gasFees: bytes32(uint256(1e4)),
            paymasterAndData: paymasterAndData,
            signature: ""
        });

        bytes32 userOpHash = keccak256(
            abi.encode(
                userOp.sender,
                userOp.nonce,
                keccak256(userOp.initCode),
                keccak256(userOp.callData),
                userOp.accountGasLimits,
                keccak256(abi.encode(repayTokensBytes, sponsorTokensBytes)),
                bytes32(abi.encodePacked(preVerificationGas, postVerificationGas)),
                userOp.preVerificationGas,
                userOp.gasFees,
                block.chainid,
                address(paymaster),
                validUntil,
                validAfter
            )
        );

        (uint8 v, bytes32 r, bytes32 s) =
            vm.sign(verifyingSignerPrivateKey, MessageHashUtils.toEthSignedMessageHash(userOpHash));
        // Append signature to paymasterAndData
        bytes memory signature = abi.encodePacked(r, s, v);

        userOp.paymasterAndData = bytes.concat(userOp.paymasterAndData, signature);

        vm.startPrank(address(entryPoint));
        (bytes memory context, uint256 validationData) =
            paymaster.validatePaymasterUserOp(userOp, userOpHash, type(uint256).max);

        // validate postOp
        // This is the event that we must track on dest chain and prove on source chain with Polymer proof system

        // Calculate the expected invoiceId
        bytes32 expectedInvoiceId =
            invoiceManager.getInvoiceId(rekt, address(paymaster), userOp.nonce, BASE_SEPOLIA_CHAIN_ID, repayTokensBytes);

        // don't know why comparison of paymaster address fails
        // even though it's the same address
        vm.expectEmit(true, true, true, false);
        emit IInvoiceManager.InvoiceCreated(expectedInvoiceId, rekt, address(paymaster));
        paymaster.postOp(IPaymaster.PostOpMode.opSucceeded, context, 1222, 42);
    }

    function testGetInvoiceId() public {
        address account = 0x5E3Ae8798eAdE56c3B4fe8F085DAd16D4912Ba83;
        address paymaster = 0xF6e64504ed56ec2725CDd0b3C1b23626D66008A2;
        uint256 nonce = 32005827482497451446878209048576;
        uint256 sponsorChainId = 84532;

        IInvoiceManager.RepayTokenInfo[] memory repayTokens = new IInvoiceManager.RepayTokenInfo[](1);
        repayTokens[0] = IInvoiceManager.RepayTokenInfo({
            vault: IVault(0x8e2048c85Eae2a4443408C284221B33e61906463),
            amount: 500,
            chainId: 11155420
        });

        bytes32 expectedInvoiceId = 0xccabf5a2f5630bf7e426047c30d25fd0afe4bff9651bc648b4174153a38e38d8;
        bytes32 computedInvoiceId =
            invoiceManager.getInvoiceId(account, paymaster, nonce, sponsorChainId, abi.encode(repayTokens));
        assertEq(computedInvoiceId, expectedInvoiceId, "Invoice ID computation mismatch");
    }

    // function testVerifyInvoice() public {
    //     bytes32 invoiceId = 0x886f7a98cfb9c6f2b6a6b4be00a89b75c0a846bf1c9b265b17ba4f9452acbc64;
    //     bytes memory proof =
    //         hex"00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000001640d989b47d36256c8eede18985987a9ef59ec16dd048d2bae790d9be4b37fa6b8e00000000000000000000000000000000000000000000000000000000012c438e000000000000000000000000000000000000000000000000000000000000208000000000000000000000000000000000000000000000000000000000000020c00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000009acb6000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000f6000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000e400000000000000000000000000000000000000000000000000000000000000ea00000000000000000000000000000000000000000000000000000000000000ee0000000000000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000004e000000000000000000000000000000000000000000000000000000000000005a00000000000000000000000000000000000000000000000000000000000000660000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000007e000000000000000000000000000000000000000000000000000000000000008c000000000000000000000000000000000000000000000000000000000000009800000000000000000000000000000000000000000000000000000000000000a400000000000000000000000000000000000000000000000000000000000000b200000000000000000000000000000000000000000000000000000000000000be00000000000000000000000000000000000000000000000000000000000000cc0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000270204e8b24d208e12943afa90bac3aab0fb591950efc79664d99aad187011d4d8b8ae03ba2d5c20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000270406e8b24d20e9caf6a4dd6892bb71fb43531df793cf16f2519260fac0ecaf9be16796f4d9c620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000027060ae8b24d2030daef3fbf15a9e6723034d8b771197eebec09f957f5c17785bca4690409385420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000027081ae8b24d2056b07448868213f555a6b174af2284f8793869ceeff974904436b9b5eff3cb6220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000270a28e8b24d20fd78b81a9670e6310f6ed51d832916fd85adf38760af73f420ae96169d990d0f20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000270c44e8b24d20c55d51dfe139f5af2d5ef686c07fbb5bb946787714f51d36d65e52829638e4fe20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000280ec401e8b24d207d7f819dbcab08495eb867e1f47fbb7c6ec07f4005289942a74c0d694880c7aa200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000002810c403e8b24d20a190ba09650015f507b0f939d5c4abc1a99f9f778d7ab60f01503307a5e61a4e20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000712ca04e8b24d200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000212006e25764f54a66f10e09ae1bb6a93cd9d36795915d41aebf649c55545782ab1500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000002814ca0ae8b24d20caa54d2923fbeea7aa0805e9e5b904fb3f00bc229cd246b5b62afd05e3a3a223200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000028168c10e8b24d20f83ecd51829306e433359c65fcde867037d07a9a12e8664d1661765988ee854320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000718fe2ee8b24d200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000212002b818877f29e4f46c7a64a7ac02d1562400673ee5ef09271dc3e30056e41bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000281a9465e8b24d2057529676445aa1d3f54e424b57412982d773d9fe6e97217a5333dcd93f190cec2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000081c8cad01e8b24d200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021208de3c5b46bbb8c0d364b7a6d64ac402991aad74d35725349008e18d020b4f1a90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000820a28f03e8b24d20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002120bc5dea1a3863bf853c6f78bd91e92d416b53d63dcc3a5e9b001cec4e7c5bc1f8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000039636861696e2f38343533322f73746f72656452656365697074732f70726f6f665f6170692f72656365697074526f6f742f3139363738303934000000000000000000000000000000000000000000000000000000000000000000000000000020d989b47d36256c8eede18985987a9ef59ec16dd048d2bae790d9be4b37fa6b8e00000000000000000000000000000000000000000000000000000000000000050002e8b24d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020292cc35c96848c21c65a6bc632a4691c951cb3725e4ccccb595fd79d833f01ad000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000021019295bc5d601c43b416e419cc8c8fd7fa2635487133e612104cb6833bd5709359000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000002101a19a397ca7a6312793316f4743b8c19c56bcf3cd50aba80b13865a27e40b5034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000002101163e8925fd6ff7a35a815eb433251fdffef29e09b1249e5d4f0176cb2c1b6fd5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000206f0658ab82ea8c13e259f0b12b70fd4cde8d7de60fb95c2927a5cbf4e66d51380000000000000000000000000000000000000000000000000000000000000007706f6c79696263000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020009df1612c8df4422f8f2004ac7a1c14bdc38e016ec9e7118b9b03bc8476d34e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000073f871a091634c2456a7d94c10a3bb39b533d47daf5e2ce340641ffc38152b3e68276bb6a0e662e95f085c6c019c89a44791508ecb08d09ae7576d67a57f922c1819bf8d7f808080808080a0ce58d857bac7a7a48c0027004318da0dab51282a433dca9fe9d3bbaffa0d0f4080808080808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f4f901f180a027a41e3e2cf012635b9f52ac964fc3ac418f44707e59713e955506442b5f2aeba00a0a5d077a3f210fd466e728ea4243ac5a9ae76e924230ddcc9b9c5b50438678a06677662dd531b242fa9b330568425282856fceef794a5f2ca65218e799f42d30a05bcd2db7e5ccd0c6635f341f9e22a233f29965cd306ebc93a021e60c616b76ffa0eda9cb9b8bdafda2cacd2b861d7f87408ffa1251e234d84ee61debe2530a711da0acadb233a9e9499ad3b91b93ca2b293f80acd75b82fc6050066a36933fbcb6ffa03a24417d10e7f03c25e385db84ae098201d000a30a3b3465f06fefaa409715bba03f83fda6b6aec77d7e74befd01f957af67b0a9db24df1c68a51202db78e4df6da0cd03d6e03c35351182c6af8e12ebb821ebe063009f10d0dada0644dfb89f7742a049db42aa0452803945c870dc049333769c53ddbd50f582d15e73eb2fe080c769a0bdcdec4f9960eebe76ebe045f7ce9ba71f513f7087d7ba1eb682a147aab6bd3aa0f62805d1294bf940aa7fa28e87472fb4b5633549c902b872f9d6db8340f245a3a02ddb4ed23bcd990fe5c0edd6ed991904d69b6c748187c1941167312961691e5aa0e41e83dd146f7bec0910da01226d299d87680185cd697f1822358d0c2e194d7ca0352491e5502bad59e90f0a11165b19d61ab2f5df18f86258100af9ffb80aea578000000000000000000000000000000000000000000000000000000000000000000000000000000000000006d5f906d220b906ce02f906ca01830cb02db9010000000000000010000000000000000000000000040000010000000000000000000008001000000000008000050000000000000000000000000000020000200000108000000000000000000008000000000041000000200040000000000000000001000000022800000000000800000800000000000000040000010010000000000000000000000000000000000000000000040000000000100400000000008000020000000000000000400000000000002000000000000000000002000004448000000002000000400001000080000000000000000000000000000000000020000010000004000000200000000002000000000080000000000000000000890000f905bff89b94ff3311cd15ab091b00421b23bcb60df02efd8db7f863a08c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925a00000000000000000000000003cb057fd3be519cb50788b8b282732edbf533dc6a0000000000000000000000000d6fe65f290d4ba8446b9efd3badad5a4bdfa98dea000000000000000000000000000000000000000000000000000000000000001f4f838940000000071727de22e5e9d8baf0edac6f37da032e1a0bb47ee3e183a558b1a2ff0874b079f3fc5478b7454eacf2bfc5af2ff5878f97280f89b94ff3311cd15ab091b00421b23bcb60df02efd8db7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa00000000000000000000000003cb057fd3be519cb50788b8b282732edbf533dc6a0000000000000000000000000d6fe65f290d4ba8446b9efd3badad5a4bdfa98dea000000000000000000000000000000000000000000000000000000000000001f4f89b94ff3311cd15ab091b00421b23bcb60df02efd8db7f863a08c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925a0000000000000000000000000d6fe65f290d4ba8446b9efd3badad5a4bdfa98dea0000000000000000000000000d129bda7ce0888d7fd66ff46e7577c96984d678fa000000000000000000000000000000000000000000000000000000000000001f4f89b94ff3311cd15ab091b00421b23bcb60df02efd8db7f863a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000d6fe65f290d4ba8446b9efd3badad5a4bdfa98dea0000000000000000000000000d129bda7ce0888d7fd66ff46e7577c96984d678fa000000000000000000000000000000000000000000000000000000000000001f4f89c94d129bda7ce0888d7fd66ff46e7577c96984d678ff884a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa00000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000d6fe65f290d4ba8446b9efd3badad5a4bdfa98dea0000000000000000000000000000000000000000000000000000000000000002680f85894d129bda7ce0888d7fd66ff46e7577c96984d678fe1a0f8e1a15aba9398e019f0b49df1a4fde98ee17ae345cb5f6b5e2c27f5033e8ce7a00000000000000000000000000000000000000000000000000000000000000026f89b94ff3311cd15ab091b00421b23bcb60df02efd8db7f863a08c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925a00000000000000000000000003cb057fd3be519cb50788b8b282732edbf533dc6a0000000000000000000000000d6fe65f290d4ba8446b9efd3badad5a4bdfa98dea00000000000000000000000000000000000000000000000000000000000000000f85a943cb057fd3be519cb50788b8b282732edbf533dc6f842a0ab6994bba319b437692f1dbbe4d689382f25c4cfa9a291959e0af1ca5cd9e13fa0886f7a98cfb9c6f2b6a6b4be00a89b75c0a846bf1c9b265b17ba4f9452acbc6480f9011d940000000071727de22e5e9d8baf0edac6f37da032f884a049628fd1471006c1482da88028e9ce4dbb080b815c9b0344d39e5a8e6ec1419fa072be8d36280e80a2c91b382858e0f39e9f47f8fc604cdc7f030da7de8637500aa0000000000000000000000000d6fe65f290d4ba8446b9efd3badad5a4bdfa98dea00000000000000000000000003cb057fd3be519cb50788b8b282732edbf533dc6b8800000000000000000000000000000000000000193fd7a5ad1000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000004f028b5b6e5a8000000000000000000000000000000000000000000000000000000000015358500000000000000000000000000000000000000000000000000000000000000000000000000000000000005383435333200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010300000000000000000000000000000000000000000000000000000000000000";
    //     IInvoiceManager.RepayTokenInfo[] memory repayTokens = new IInvoiceManager.RepayTokenInfo[](1);
    //     repayTokens[0] = IInvoiceManager.RepayTokenInfo({
    //         vault: IVault(0xeFb7144787FFFCEF306bC99cEBF42AB08d5609c8),
    //         amount: 500,
    //         chainId: 11155420
    //     });
    //     IInvoiceManager.InvoiceWithRepayTokens memory invoice = IInvoiceManager.InvoiceWithRepayTokens({
    //         account: 0xd6fe65f290d4BA8446b9EfD3BadAD5A4Bdfa98De,
    //         nonce: 32007397118551674307018261266432,
    //         paymaster: 0x3cB057Fd3BE519cB50788b8b282732edBF533DC6,
    //         sponsorChainId: 84532,
    //         repayTokenInfos: repayTokens
    //     });

    //     console.logBytes(abi.encode(invoice));
    //     assert(paymaster.verifyInvoice(invoiceId, invoice, proof));
    // }
}
